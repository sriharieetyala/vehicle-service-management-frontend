<div class="page-container">
    <div class="container">
        <div class="page-header">
            <div>
                <a routerLink="/technician" class="back-link"><i class="bi bi-arrow-left"></i> Back</a>
                <h1>My Tasks</h1>
            </div>
        </div>

        <!-- Filter -->
        <div style="margin-bottom:15px;padding:10px 15px;background:white;border-radius:6px;border:1px solid #e2e8f0">
            <select [(ngModel)]="selectedStatus" (change)="applyFilter()"
                style="padding:6px 10px;border:1px solid #ccc;border-radius:4px">
                @for (s of filterStatuses; track s) {
                <option [value]="s">{{ s.replace('_', ' ') }}</option>
                }
            </select>
            <span style="margin-left:12px;color:#64748b">{{ tasks.length }} results</span>
        </div>

        @if (isLoading) {
        <div class="loading">Loading...</div>
        } @else if (tasks.length === 0) {
        <div class="empty-state">
            <i class="bi bi-check-circle"></i>
            <p>No tasks assigned</p>
        </div>
        } @else {
        <div class="task-list">
            @for (task of tasks; track task.id) {
            <div class="task-card">
                <div class="task-status" [class]="getStatusClass(task.status)">{{ task.status.replace('_', ' ') }}</div>
                <div class="task-info">
                    <h3>{{ task.serviceType.replace('_', ' ') }}
                        @if (task.priority === 'URGENT') {
                        <span class="urgent-badge">URGENT</span>
                        }
                    </h3>
                    <p>{{ task.description || 'No description' }}</p>
                    @if (task.pickupRequired && task.pickupAddress) {
                    <p class="pickup-info"><i class="bi bi-geo-alt-fill"></i> <strong>Pickup:</strong> {{
                        task.pickupAddress }}</p>
                    }
                    @if (task.preferredDate) {
                    <p class="meta"><i class="bi bi-calendar"></i> Preferred: {{ task.preferredDate | date:'mediumDate'
                        }}</p>
                    }
                    <p class="meta">
                        <span>Bay {{ task.bayNumber || '-' }}</span>
                        <span>{{ task.createdAt | date:'shortDate' }}</span>
                    </p>
                </div>
                <div class="actions">
                    @if (task.status !== 'COMPLETED') {
                    <button class="btn btn-primary" (click)="openStatusModal(task)">Update Status</button>
                    }
                </div>
            </div>
            }
        </div>
        }
    </div>
</div>

<!-- Status Modal -->
@if (showStatusModal) {
<div class="modal-backdrop" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Update Task Status</h3>
            <button class="modal-close" (click)="closeModal()"><i class="bi bi-x"></i></button>
        </div>

        <form [formGroup]="statusForm" (ngSubmit)="submitStatus()">
            <div class="form-group">
                <label>New Status</label>
                <select formControlName="status">
                    <option value="">Select status</option>
                    @for (s of statuses; track s) {
                    <option [value]="s">{{ s.replace('_', ' ') }}</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea formControlName="notes" rows="3" placeholder="Add any notes..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" [disabled]="statusForm.invalid || isSubmitting">
                    {{ isSubmitting ? 'Updating...' : 'Update' }}
                </button>
            </div>
        </form>
    </div>
</div>
}